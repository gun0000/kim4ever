<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 쿼리만드는곳 -->
<mapper namespace="com.myezen.myapp.persistance.GatheringService_Mapper">
	
	<!-- 모임생성 1.모임정보생성 -->
	<insert  id="gatheringInfoCreate" parameterType="com.myezen.myapp.domain.GatheringJoinVo" >
	  	INSERT INTO GATHERING_INFO1234 (GIIDX,GINFONAME,GINFOAREA,GINFOBRIEFINTRODUCTION,GINFOAREAINTRODUCTION,GINFOCAPACITY,gInfoParticipating,GINFOCREATIONDAY,GINFOJOINTYPE)
		VALUES(giidx_seq.NEXTVAL, #{gInfoName}, #{gInfoArea}, #{gInfoBriefIntroduction}, #{gInfoAreaIntroduction}, #{gInfoCapacity},'1', SYSDATE,#{gInfoJoinType})
	</insert>
	<!-- 모임생성 2.모임생성-->
	<insert  id="gatheringCreate" parameterType="com.myezen.myapp.domain.GatheringJoinVo" >
		INSERT INTO GATHERING1234 (GIDX,GIIDX,MIDX,GATHERINGAPPROVALTYPE,GATHERINGMEMBERTYPE,GATHERINGJOININGDAY)
		VALUES(GIDX_SEQ.NEXTVAL ,GIIDX_SEQ.CURRVAL , #{midx}, 'Y', 'TL', SYSDATE)
	</insert>
	<!-- 모임생성 3.모임대표 이미지 넣기-->
	<insert  id="gatheringGTInsert" parameterType="com.myezen.myapp.domain.GatheringJoinVo" >
		INSERT INTO IMAGE1234 (IMIDX,IMAGENAME,MIDX,GIIDX,IMGTYPE,IMGCREATIONDAY)
		VALUES(IMIDX_SEQ.NEXTVAL,#{imageName},#{midx},GIIDX_SEQ.CURRVAL,'GT',SYSDATE)
	</insert>
	<!-- 모임생성 4.모임 이미지 넣기-->
	<insert  id="gatheringGInsert" parameterType="com.myezen.myapp.domain.GatheringJoinVo" >
		INSERT INTO IMAGE1234 (IMIDX,IMAGENAME,MIDX,GIIDX,IMGTYPE,IMGCREATIONDAY)
		VALUES(IMIDX_SEQ.NEXTVAL,#{imageName},#{midx},GIIDX_SEQ.CURRVAL,'G',SYSDATE)
	</insert>
	<!-- 모임 리스트 가져오기 -->
	<select id="gatheringListSelect" resultType="com.myezen.myapp.domain.GatheringJoinVo">
		SELECT a.*, b.*, COALESCE(c.gwidx, 0) AS gwidx
		FROM GATHERING_INFO1234 a
		JOIN IMAGE1234 b ON b.GIIDX = a.GIIDX
		LEFT JOIN gathering_wish1234 c ON c.GIIDX = a.GIIDX
		WHERE b.IMGTYPE = 'GT'
	</select>
	<!--  모임 나의 리스트 가져오기 -->
	<select id="gatheringMyListSelect" resultType="com.myezen.myapp.domain.GatheringJoinVo" parameterType="int"> 
		SELECT a.GIIDX,a.GINFONAME,a.GINFOBRIEFINTRODUCTION,a.GINFOCAPACITY,a.GINFOPARTICIPATING,b.IMAGENAME, COALESCE(c.gwidx, 0) AS gwidx 
		FROM GATHERING_INFO1234 a
		JOIN IMAGE1234 b ON b.GIIDX = a.GIIDX
		JOIN GATHERING1234 c ON c.GIIDX = a.GIIDX
		LEFT JOIN gathering_wish1234 c ON c.GIIDX = a.GIIDX
		WHERE b.IMGTYPE = 'GT' AND c.midx = #{0} AND a.GINFODELYN = 'N'
	</select>
	<!--  모임 소개페이지 리스트 가져오기 -->
	<select id="gatheringOneSimpleListSelect" resultType="com.myezen.myapp.domain.GatheringJoinVo" parameterType="int"> 
		SELECT * FROM GATHERING_INFO1234 a
		JOIN IMAGE1234 b ON b.GIIDX = a.GIIDX
		WHERE b.IMGTYPE = 'G' AND a.GINFODELYN = 'N' AND a.GIIDX = #{0}
	</select>
	
	<!-- 사용자가 모임상세페이지를 들어갈수있는지 확인 -->
	<select id="gatheringMemberCheck" resultType="int" parameterType="int"> 
		SELECT COUNT(*) FROM GATHERING1234 a
		WHERE midx = #{1} AND giidx = #{0} AND GATHERINGAPPROVALTYPE = 'Y'
	</select>
	<!-- 모임상세리스트 가져오기-->
	<select id="gatheringOneListSelect" resultType="com.myezen.myapp.domain.GatheringJoinVo" parameterType="int"> 
 		SELECT 
		  a.GIIDX,GINFONAME,GINFOAREA,GINFOBRIEFINTRODUCTION,GINFOAREAINTRODUCTION,GINFOCAPACITY,GINFOPARTICIPATING
		  ,IMAGENAME,IMGTYPE
		  ,GATHERINGAPPROVALTYPE,GATHERINGMEMBERTYPE
		  ,c.MIDX
		  ,d.MEMBERNAME,d.MEMBERPROFILE
		FROM GATHERING_INFO1234 a
		JOIN IMAGE1234 b ON b.GIIDX = a.GIIDX
		JOIN GATHERING1234 c ON a.GIIDX = c.giidx
		JOIN member1234 d ON c.midx = d.midx
		WHERE b.IMGTYPE = 'G' AND a.GINFODELYN = 'N' AND c.GATHERINGMEMBERTYPE = 'TL'  AND a.GIIDX = #{0}
	</select>
	<!-- 모임멤버 리스트 가져오기 -->
	<select id="gatheringMemberListSelect" resultType="com.myezen.myapp.domain.GatheringJoinVo" parameterType="int"> 
		SELECT a.*,b.MEMBERPROFILE
		FROM GATHERING1234 a
		JOIN MEMBER1234 b ON b.midx = a.midx
		WHERE a.GIIDX = 62 AND b.MEMBERDELYN = 'N' AND a.GATHERINGMEMBERDELYN = 'N'
	</select>
	<!-- 모임공지사항 리스트 가져오기 -->
	<select id="gatheringNoticeListSelect" resultType="com.myezen.myapp.domain.Gathering_BoardVO" parameterType="int"> 
		SELECT *
		FROM GATHERING_BOARD1234 a
		WHERE a.GIIDX = #{0} AND gBoardDelYN = 'N' AND gBoardCategory ='공지사항'
        ORDER BY GBOARDWRITEDAY DESC
	</select>
	
	
	
	<!-- 모임 가입타입 확인하기-->
	<select id="gatheringJoinTypeCheck" resultType="com.myezen.myapp.domain.Gathering_InfoVo" parameterType="int"> 
		SELECT ginfojointype FROM GATHERING_INFO1234 a WHERE a.GIIDX = #{0} AND GINFODELYN = 'N'
	</select>
	<!-- 가입타입 확인후 데이터넣기 자유가입-->
	<insert  id="gatheringJoinTypeAInsert" parameterType="int" >
	 	INSERT INTO gathering1234 (GIDX,GIIDX,MIDX,GATHERINGAPPROVALTYPE,GATHERINGMEMBERTYPE,GATHERINGJOININGDAY)
		VALUES(gidx_seq.NEXTVAL, #{0},#{1},'Y','TM',SYSDATE)
	</insert>
	<!-- 가입타입 확인후 데이터넣기 승인가입-->
	<insert  id="gatheringJoinTypeBInsert" parameterType="int" >
	 	INSERT INTO gathering1234 (GIDX,GIIDX,MIDX,GATHERINGAPPROVALTYPE,GATHERINGMEMBERTYPE,GATHERINGJOININGDAY)
		VALUES(gidx_seq.NEXTVAL, #{0},#{1},'W','TM',SYSDATE) 
	</insert>
	<!-- 모임 가입 참여멤버 수 1++업데이트 -->
	<update id="gatheringParticipatingUpdate" parameterType="int">
	  UPDATE GATHERING_INFO1234
	  SET gInfoParticipating = gInfoParticipating + 1
	  WHERE GIIDX = #{0}
	</update>
	<!-- 찜하기 -->
	<insert  id="gatheringWish" parameterType="int" >
	 	INSERT INTO gathering_wish1234 (gwidx,GIIDX,MIDX)
		VALUES(gwidx_seq.NEXTVAL, #{0},#{1}) 
	</insert>
	<!-- 찜삭제 -->
	<delete id="gatheringWishDel" parameterType="int">
	  DELETE FROM gathering_wish1234
	  WHERE giidx = #{0} and midx = #{1}
	</delete>
	<!--  모임 나의 찜 리스트 가져오기 -->
	<select id="gatheringMyWishListSelect" resultType="com.myezen.myapp.domain.GatheringJoinVo" parameterType="int"> 
		SELECT a.GIIDX,a.GINFONAME,a.GINFOBRIEFINTRODUCTION,a.GINFOCAPACITY,a.GINFOPARTICIPATING,b.IMAGENAME, COALESCE(c.gwidx, 0) AS gwidx 
		FROM GATHERING_INFO1234 a
		JOIN IMAGE1234 b ON b.GIIDX = a.GIIDX
		JOIN GATHERING1234 c ON c.GIIDX = a.GIIDX
		JOIN gathering_wish1234 c ON c.GIIDX = a.GIIDX
		WHERE b.IMGTYPE = 'GT' AND c.midx = #{0} AND a.GINFODELYN = 'N'
	</select>	
	<!-- 모임 검색기능 -->
	<select id="searchGatherings" resultType="com.myezen.myapp.domain.GatheringJoinVo" parameterType="com.myezen.myapp.domain.SearchCriteria">
	    SELECT a.GIIDX, a.GINFONAME, a.GINFOBRIEFINTRODUCTION, a.GINFOCAPACITY, a.GINFOPARTICIPATING, b.IMAGENAME,COALESCE(d.gwidx, 0) AS gwidx
	    FROM GATHERING_INFO1234 a
	    JOIN IMAGE1234 b ON b.GIIDX = a.GIIDX
	    JOIN GATHERING1234 c ON c.GIIDX = a.GIIDX
	    LEFT JOIN gathering_wish1234 d ON d.GIIDX = a.GIIDX
	    WHERE b.IMGTYPE = 'GT' AND a.GINFODELYN = 'N'
	    <if test="keyword != null">
	        AND a.GINFONAME LIKE '%'||#{keyword}||'%'
	    </if>
	</select>
	

	<!-- 모임 일정 만들기 -->
	<insert  id="gatheringScheduleMake" parameterType="com.myezen.myapp.domain.Gathering_ScheduleVO" >
	 	INSERT INTO gathering_schedule1234 (GSIDX,GIIDX,MIDX,GSCHEDULETITLE,GSCHEDULESTARTDAY,GSCHEDULEENDDAY,GSCHEDULELOCATION,GSCHEDULELATITUDE,GSCHEDULELONGITUDE,GSCHEDULEARRANGEMENTS,GSCHEDULECAPACITY,GSCHEDULEFEE,GSCHEDULEWRITEDAY,gScheduleDelYN)
		VALUES(gsidx_seq.NEXTVAL, #{giidx},#{midx},#{gScheduleTitle},#{gScheduleStartDay},#{gScheduleEndDay},#{gScheduleLocation},#{gScheduleLatitude},#{gScheduleLongitude},#{gScheduleArrangements},#{gScheduleCapacity},#{gScheduleFee}, SYSDATE,'N')
	</insert>
	<!--  모임 일정 리스트 가져오기 -->
	<select id="gatheringScheduleListSelect" resultType="com.myezen.myapp.domain.Gathering_ScheduleVO" parameterType="int"> 
		SELECT * FROM gathering_schedule1234 WHERE  GSCHEDULEDELYN = 'N' AND GIIDX = #{0}
	</select>
	<!--  모임 일정 상세보기 가져오기 -->
	<select id="gatheringScheduleView" resultType="com.myezen.myapp.domain.Gathering_ScheduleVO" parameterType="int"> 
		SELECT * FROM gathering_schedule1234 WHERE  GSCHEDULEDELYN = 'N' AND GSIDX = #{0} AND GIIDX = #{1}
	</select>
	
	<!-- 모임 게시판 -->
	<!--  모임 게시글 쓰기 -->
	<insert  id="gatheringBoardWrite" parameterType="com.myezen.myapp.domain.Gathering_BoardVO" >
		INSERT INTO gathering_board1234 (gbidx,giidx,midx,gBoardTitle,gBoardCategory,gBoardContents,gBoardWriteDay,gBoardDelYN)
		VALUES(gbidx_seq.NEXTVAL, #{giidx},#{midx},#{gBoardTitle},#{gBoardCategory},#{gBoardContents},SYSDATE,'N')
	</insert>
	    <sql id="search">
        <if test="searchType != null and searchType.equals('gBoardTitle')"><!-- 동적 SQL  -->
            and gBoardTitle like '%'|| #{scri.keyword} ||'%'
        </if>
        <if test="searchType != null and searchType.equals('gBoardContents')">
            and gBoardContents like '%'|| #{scri.keyword} ||'%'
        </if>
    </sql>
    <!--  모임 총게시글 가져오기 -->
    <select id="gatheringBoardTotal" resultType="int" parameterType="java.util.HashMap"> 
        SELECT count(*) as cnt
        FROM GATHERING_BOARD1234 a
        JOIN member1234 b ON b.midx = a.midx
        JOIN GATHERING1234 c ON c.giidx = a.giidx AND c.midx = a.midx
        WHERE gBoardDelYN = 'N' AND memberdelyn = 'N' AND gatheringMemberDelYN = 'N' AND a.GIIDX = #{giidx}
        <include refid="search"></include>
    </select>
    <!--  모임 게시글 리스트 가져오기 -->
    <select id="gatheringBoardListSelect" resultType="com.myezen.myapp.domain.GatheringJoinVo" parameterType="java.util.HashMap"> 
        SELECT *
        FROM (
            SELECT ROWNUM AS rnum, A.*
            FROM (
                SELECT a.*, b.memberName, b.memberProfile, c.gatheringMemberType
                FROM GATHERING_BOARD1234 a
                JOIN member1234 b ON b.midx = a.midx
                JOIN GATHERING1234 c ON c.giidx = a.giidx AND c.midx = a.midx
                WHERE gBoardDelYN = 'N' AND memberdelyn = 'N' AND gatheringMemberDelYN = 'N' AND a.GIIDX = #{giidx} <include refid="search"></include>
                ORDER BY CASE WHEN GBOARDCATEGORY = '공지사항' THEN 0 ELSE 1 END, GBOARDWRITEDAY DESC
            ) A
        )
        WHERE rnum BETWEEN (#{scri.page}-1)*#{scri.perPageNum}+1 AND #{scri.page}*#{scri.perPageNum} 
    </select>
        <!--  모임 게시글 보기 -->
    <select id="gatheringBoardOneSelect" resultType="com.myezen.myapp.domain.GatheringJoinVo" parameterType="int"> 
       SELECT a.*, b.memberName, b.memberProfile, c.gatheringMemberType
       FROM GATHERING_BOARD1234 a
       JOIN member1234 b ON b.midx = a.midx
       JOIN GATHERING1234 c ON c.giidx = a.giidx AND c.midx = a.midx
       WHERE gBoardDelYN = 'N' AND memberdelyn = 'N' AND gatheringMemberDelYN = 'N' AND a.GIIDX = #{0} AND a.GBIDX = #{1}
    </select>
	<!--  모임 게시글에서 댓글 작성하기 -->
	<insert id="gatheringBoardCommentAdd"  parameterType="com.myezen.myapp.domain.Gathering_CommentVO"> 
		INSERT INTO gathering_comment1234 (gcidx,gbidx,midx,gCommentContents,gCommentWriteDay,gCommentDelYN)
		VALUES(gcidx_seq.NEXTVAL, #{gbidx},#{midx},#{gCommentContents},SYSDATE,'N')
	</insert>
	<sql id="searchComment">
		<if test="searchType != null and searchType.equals('gBoardTitle')"><!-- 동적 SQL  -->
			and gBoardTitle like '%'|| #{scri.keyword} ||'%'
		</if>
		<if test="searchType != null and searchType.equals('gBoardContents')">
			and gBoardContents like '%'|| #{scri.keyword} ||'%'
		</if>
	</sql>
	<!--  모임 총댓글 가져오기 -->
	<select id="gatheringBoardCommentTotal" resultType="int" parameterType="java.util.HashMap"> 
        SELECT count(*) as cnt
        FROM Gathering_Comment1234 a
        JOIN GATHERING_BOARD1234 b ON b.GBIDX = a.GBIDX 
        JOIN member1234 c ON c.midx = a.midx
        JOIN GATHERING1234 d ON  d.midx = a.midx AND d.giidx = b.giidx
        WHERE  memberdelyn = 'N' AND gatheringMemberDelYN = 'N' AND gCommentDelYN = 'N'  AND a.gbidx = #{gbidx}
		<include refid="searchComment"></include>
	</select>
	<!--  모임 댓글 리스트 가져오기 -->
	<select id="gatheringBoardCommentListSelect" resultType="com.myezen.myapp.domain.GatheringJoinVo" parameterType="java.util.HashMap"> 
		SELECT *
		FROM (
		    SELECT ROWNUM AS rnum, A.*
		    FROM (
		        SELECT a.*, c.memberName, c.memberProfile, d.gatheringMemberType
		        FROM Gathering_Comment1234 a
		        JOIN GATHERING_BOARD1234 b ON  b.GBIDX = a.GBIDX
		        JOIN member1234 c ON c.midx = a.midx
		        JOIN GATHERING1234 d ON d.giidx = b.giidx AND d.midx = a.midx
		        WHERE gBoardDelYN = 'N' AND memberdelyn = 'N' AND gatheringMemberDelYN = 'N' AND a.gbidx = #{gbidx}
		        ORDER BY  gCommentWriteDay DESC
		    ) A
		)
		WHERE rnum BETWEEN (#{scri.page}-1)*#{scri.perPageNum}+1 AND #{scri.page}*#{scri.perPageNum}
	</select>
	
	
	<!-- 모임 신고-->
	<insert id="insertDeclaration" parameterType="com.myezen.myapp.domain.GatheringJoinVo">
	INSERT INTO gathering_declaration1234(gdix, giidx, midx, gatheringReportContent, gatheringDeclarationDay)
	values(gdix_seq.NEXTVAL, #{giidx}, #{midx}, #{gatheringReportContent},sysdate)
	</insert>
	
	



	<!-- 모임 더보기 멤버 리스트 , 추방 , 권한 위임 -->

	<!--  모임 더보기 현재 사용자 멤버타입 가져오기  -->
		<select id="gatheringMemberType" resultType="com.myezen.myapp.domain.GatheringVo" parameterType="int"> 
			SELECT GATHERINGMEMBERTYPE
			FROM GATHERING1234 a
			JOIN MEMBER1234 b ON b.midx = a.midx
			WHERE a.GIIDX = #{0} AND b.MEMBERDELYN = 'N' AND a.GATHERINGMEMBERDELYN = 'N' AND b.midx = #{1}
		</select>
	<!--  모임 더보기 멤버 리스트 -->
		<select id="gatheringSeeMoreMemberList" resultType="com.myezen.myapp.domain.GatheringJoinVo" parameterType="int"> 
			SELECT a.*,
				b.memberProfile,
				b.memberName,
				b.memberIntro,
				b.memberAddrs
			FROM GATHERING1234 a
			JOIN MEMBER1234 b ON b.midx = a.midx
			WHERE a.GIIDX = #{GIIDX}
				AND b.MEMBERDELYN = 'N'
				AND a.GATHERINGMEMBERDELYN = 'N'
			ORDER BY CASE WHEN a.GATHERINGMEMBERTYPE = 'TL' THEN 1
			              WHEN a.GATHERINGMEMBERTYPE = 'TLM' THEN 2
			              WHEN a.GATHERINGMEMBERTYPE = 'TM' THEN 3
			              ELSE 4
			END
		</select>

	<!--  모임 더보기 모임원 추방으로 변경 -->
		<update id="updateMemberDELYN" parameterType="int">
	    UPDATE GATHERING1234 SET GATHERINGMEMBERDELYN = 'Y' WHERE giidx = #{0} and midx = #{1}
		</update>
		
	
		
	  <delete id="exitGathering" parameterType="int">
	   DELETE FROM gathering1234 WHERE midx = #{0} AND giidx = #{1} AND GATHERINGMEMBERTYPE IN ('TM', 'TMD')
	  </delete>
	

</mapper>